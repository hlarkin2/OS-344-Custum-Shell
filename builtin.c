#define _POSIX_C_SOURCE 200809L

#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include "builtin.h"
#include "utils.h"


// -----------------------------
// Built-in command definitions
// -----------------------------

int shell_cd(char **args) {
    if (args[1] == NULL) {
        fprintf(stderr, "customshell: expected argument to \"cd\"\n");
        return 1;
    }

    if (chdir(args[1]) != 0) {
        perror("customshell");
    }

    return 1;
}

int shell_exit(char **args) {
    return 0;   // returning 0 tells main loop to exit
}


int shell_help(char **args) {
    printf("\nWelcome to the Linux terminal!\n");
    printf("Begin by entering a valid command, such as 'ls' to list files,\n");
    printf("or 'cd <directory>' to change the working directory.\n\n");

    printf("Custom built-in commands:\n");
    printf("  help    : show this help message\n");
    printf("  next    : suggests a useful next command\n");
    printf("  wlfc    : who loves fried chicken?\n");
    printf("  cd      : change directories\n");
    printf("  exit    : exit EduShell\n\n");

    printf("Supported Linux commands:\n");
    printf("  ls      : list the contents of the current directory\n");
    printf("  pwd     : print the current working directory\n");
    printf("  rm      : remove a file or directory\n");
    printf("  mv      : move or rename a file or directory\n");
    printf("  cp      : copy a file or directory\n");
    printf("  mkdir   : create a new directory\n");
    printf("  touch   : create a file or update its timestamp\n");
    printf("  cat     : print the contents of a file\n");
    printf("  grep    : search for text patterns within files\n");
    printf("  chmod   : change file permissions\n");
    printf("  chown   : change file owner and group\n");
    printf("  ps      : display running processes\n");
    printf("  top     : show real-time system process usage\n\n");

    return 1;
}

#include <stdio.h>
#include <unistd.h> // for usleep

int shell_history(char **args) {
    if (history_count == 0) {
        printf("No commands in history.\n");
        return 1;
    }

    printf("Last %d commands:\n", history_count);
    for (int i = 0; i < history_count; i++) {
        printf("%d: %s : %s\n", i+1, history[i].command, history[i].description);
    }

    return 1;
}


int shell_wlfc(char **args) {

    const char *art[] = {
        ".............................................................................................................................................",
        ".............................................................................................................................................",
        ".............................................................-#@@@@@@@@@@@@@+................................................................",
        "....................................................-@@@@@@@@@@@@@%%###%@@@@@@@@@@@@@#.......................................................",
        "...............................................@@@@@@@@%#%@@%%##%##%####%######**##%@@@@@@@#.................................................",
        "...........................................@@@@@@#**##@@@@=+###=--.:-=++#%@%%##++=====+*#%@@@@@@.............................................",
        ".......................................%@@@@#*###%@@@@+..:*=..=%@@@@@@%+==-=@@@@@@@%%#=--=+###@@@@@..........................................",
        "....................................%@@@@####*%@@@@=...=#-.=@@@@@%%%@@@@@.....=@@@@@@@@@@#--+#*##%@@@@:......................................",
        ".................................+@@@@##**##@@@%...:*@@.:+@@@@@@@@%@@@@=-@@@@@@+--#@@@@@@@@@+-=*#####@@@@....................................",
        "...............................@@@@##*##**%@#=...%@@@..*@@@@@@%@@%#@@@##@@@@@..+@%+=+#%@@%@@@@+-+*#####%@@@#.................................",
        ".............................@@@%#########%#..#@@:...%@@@@@@#@@@%#@@@%#@@@%%@@@%@%%###%@@%@@@@@@-=++*#####%@@@...............................",
        "...........................@@@###########+==:*#...%@@@@@@#+*%@@%+%@@@%@@#%@%#@@@#=....:==#%%%@@@@+:=+*#*####@@@@.............................",
        ".........................@@@########*#**+*-#@:+@@@@@@+##-=@@@@+%%@%%@@@%@@#*@@@@@@@@@@@@@@#=+@@#@@@=+*####*###%@@+...........................",
        ".......................#@@%####*#***#*=+=@@=.*@@@%=-#@##@@@@*=#@@#%@@#=@@#=@@@%@@@@+...=*@@@@*#@@@@%=+*#*#*#####@@@..........................",
        "......................@@@#######**##++##@%..%@@+.:*#*+@@@%=+%@%@@@@@=%@@+:@@%#@@@@@@@@@##**%@@@#@@@@%-+#*##*#####*@@@........................",
        "....................@@@#############*+%@=-@@@@%#--=#@@@#..+%+#@@@@#+#%#%:#%#%%%@#@%%@@@@%%%%*@@@@#@@@*+#####******#%@@.......................",
        "...................@@%#############*+=%+#@@%@#%-=@@=....@@@@@@@@%=:%#-##=@@@%%#==###%@@@@@@%%%##@@@@@@-*##########*##@@@.....................",
        "..................@@######*########*+@@@@##*#*=*@#:.##@@%+*-:..=-=@#+-%+*%%%%%#*%%%##%%@#@@@%%@@%@@%@@=+##*#######*#*#%@@....................",
        ".................@@##*####*##**####*++*@#%@@--*@=%%@@=+=*...+:+*.++=+=%*#@@@@%##%%%%###@@*%%@#%@@@%%@@++#*#**##########%@@...................",
        "...............:@@##############**#*#%##@%%+-%%#-@%#%@@+..#@-#%-=@@#*%@@@@@%#%%%%%%%%%#+@%@@@%%##@@#%@#-+*###*##########%@@..................",
        "...............@@#####*###*###**###=*@%@@@@#@##@@@#@@@#*@@@*+##@@@#%@@@@@#+++++#%%%%%%%++%#*%@%%=%@@@@@==*#**##*##########@@.................",
        "..............@@##########**####*##+*%@@++#@@@@@@@@@#=@@@%=#%#@@@@@@@@%+-..----::.:--+%%*%@@%#%@@*@@@@@@+*###**############@@................",
        ".............@@###########*##*#***#*=%%@@+=%@%#*=-*-......#%=...:-====:--=#%*#@@@#++##+##*#@@@++@@@%@@@@-+******#**########%@@...............",
        "............@@############*###***###*-++%:....+@....:=.........:..-+....*#-+#@@@@@@@@@@@%#+#@@@#%@@%@@%==**#****#*#*########@@...............",
        "...........=@%#########*##*#*#****##--*-+%*-@@@...-#%@@@@@@@@*+%#-##.:-+@%+%@@%#*--+#%#@@@%*+#@@@@@@@@#=+****+*+*+***########@@..............",
        "...........@@##########*#*********##:.@@+==@@#..--+%%@#---:::-----%*:+%%@%#=.........-**####*#@@@@@%+..=**###*#****###########@@.............",
        "..........*@#########**###**#*****###.:%++@@#....:-........:=#%%@%.....:=#%@@@@@@@@@@@#++*#%=@@*#+=+@@:=******#*#**###########@@.............",
        "..........@@##############*#********%@%#@@@@@@@......@@@@@@@@@@@@@@@@@@@@@@*%@@=@@@#%@@@@@@#@@+*#%@@@@#=++******##*##**########@@............",
        ".........-@#######*#****##*+******+##=.....-+@@@@@@@@@@==*%-.+#%%..-...=%%*........:+#@@@@@.@##%%-=*%@#=+*********+**##########%@............",
        ".........@@#####*####*#*#*#*#**+****#+@@@#.....:+@@@+.....+@@@@#:.*@%--@@@@*+*@@@@@@@@*++#=:@@#%@%%##@#=+++*++*****#***####*###%@+...........",
        ".........@######*####*##*******++**##.+....:=--:.-=---*##*++==::-.@+:..=@@#%#-...:...-=+*+.%%%%%@@#%@@==+++++********#**########@@...........",
        ".........@###*####*#*****+++*****+++#-=.--:@*-=:.=*=---+#@#*=:-:::*..:--+#=----++*+++==-+#@@@%%%+@#%@.-+++++++*****#*#*#*##*####@@...........",
        "........%@##*###***#**#*******++*+++##..:.+@+++%---.:=%*=:.....:++..::+-+%%@@@:-+#@%##**#*#@%%%%*@@@=-+++++++++***+***##########%@...........",
        "........@@###*#**+***+*+*******++++++#%:..#+.=++:--.:..::...-%@@=-:-..=-=%@=-@@...:::-.-##%%%%%%%#%%-=++++++++++****#############@...........",
        "........@@#####*#*##*****+++*****+++++#@:.-#++++-::--......:+@%........:-:...-@@#..-=++*##@%%%%%%%@#-=++++++++++*+***############@...........",
        "........@@********+*+*+**++++++++***+++#%--..+++==--=:--==+#@%......-==#*++#@@@@@@%+-++##%@%%%#%%%@*-+++++**+++++*+*+***#*#*####*@...........",
        "........@@****#********++*++++++++++++++#=:-=+++++++--=.-#*@@-.@@@@@@@@@@@@@@@@@@@@++###%@@%%%%%#+@@=+*++++++++***+**+********###@...........",
        "........@@**+**+*****+*+*+++++++++++++++##..:++-=*++==+#@@@@=........=#..-+=++**+*#+++#%@@@@%%@@@@@#=+*+++++++++*+***#**###*#**##@...........",
        "........+@*+***+++++*+*++++++++++++++++++=...-+---=+*%#**@%:.:.:.........-=:...:=**%#*##%%%%#%@:...-++*+++++++******##*##****+*#%@...........",
        ".........@*+++++++++++++++++++++++++++++**+@%.++---==:-=+#-......:-%@%:=@@%@@@@@@@%@%++*@%%##@@-=+++++++++*+++************#****#@@...........",
        ".........@%**+*++++*+++++++++++++++++++++++#*.:+=:-===-.:=--%@@@@@@@@@@@@@@@@%#%@@@#=-=*@%%%%@*-+*+++*+**+**+******#*#********##@%...........",
        ".........@@+*+*++++++++++++++++++++===+=++=--*..+-::---::=@@@#-.............=@@@###=-=#%**#%@@-=**++++++++***************#**##*%@............",
        "..........@#*+*++++*+++++++++++++++=++++=-.:@@@:-+-------*@#..:+@@@@===+#@@@@@@%#%%+=+#%%@@@@+-++#++++*+++***+****+***+***#*#*#@@............",
        "..........@@*+*++++++++++++++++=+++=====:.=@@@@.=##=--=+=======---%@@@@@@@@@%####*=-=%@%%%@@::++++++*++++++**+**+++*+*+*******#@+............",
        "...........@%+*++++++++++++++++=+++=+=-.-@@@@@@@.+@%+=-==-::-===:...........-*#==--+@@@%@@@-.-=+**+*+**+*++++++*******+*****##@@.............",
        "...........%@#*++++++++++++++++===+==:.@@@%%%#%@%..@@@+==++-..::::-::-..=+=..+*:-+#%@%%%@%+@@..=**+++++++++*++***************%@..............",
        "............@%*+++++++++=+==++====:..=@@###%%%#@@@...@@@%=+=-:::..:..-=:=-:+%#*-+%@@%%@@@%.@@@+...-=+++++++++++++++*+*++***+#@%..............",
        "............-@#+++++++++++===-:....+%%#**##%####@@@....+@@@@##-..:::-===*%@%*=+#@@@@@@@@@-.#@@@@@%:...-=++++++++++++*+******@@...............",
        ".............@@#+++++++++=-:..-*%@@@@@%%##%%%%%%%@@@......+@@@@@@####*+*%@@%%@@@@@@@%@@#-==-@@@@@@@@@%....-+++++++++**+****@@................",
        "..............@@#++*+==-:.-+%@@@@@@@@@%%%%%%%%#%%%@@@........:@@@@@@@@@@@@@@@@@%%###@@+-**+.@@@@@@@@@@@@@*....-++++++*++**%@-................",
        "...............@@*=---=*#%%@%%@@@%#%@%%%###%%##%##%@@@....-:.....=@@@@@%#%#%%%%%#%@@@-=*+++:@@@@@@@@%@@@@@@@@=....-=+**+*@@:.................",
        "................@@*+##%#*#%%@@%%@%%%%#%%%##%%#%%##%%%@@.....:::......-%@@@@@%%%@@@@--+*++++:%@@@@@@@@@@@@@@@@@@@@#:....-%@:..................",
        ".................@@@*+##%@@@@%%%@#%%@@%#%%%%####@%%%%%@@......:-:--.......-@@@%+...-==+=*++=#@@@@@@@@@@@@@@@@@@@@@@@@@#%@....................",
        "..................#@@%@%@@%%%#%%%-##@@@%#####%%@%###%%%@@.........-----:.....==@@#.-=+++*++++@@@@@@@@@@@@@@@@@@@@@@@@@@@:....................",
        "....................@@@@%%%#%%%@@@@%##%@@%%%%@%#%%%%###%@@+............::..*@@@##@@-.:++*+++=@@%@@@@@@@@@@@@@@@@@@@@@@@......................",
        ".....................@@@%%%%%%#%%#%@@@@###%%%#%%#%%%%%%#%@@+...........:...@-*@*@@@@@=.=+*++=@@%@@@@@@@@@@@@@@@@@@@@@+.......................",
        ".......................@@@%%%#%%%##%#*#@@@%%%#%#%%%%#%%##@@@=.............@@#*%@@%%@@@=.++++=@@@%@@@@@@@@@@@@@@@@@@@.........................",
        "........................@@@@%%%%%%#%%###*#%%%#%@##%%%%%%%%%@@.......:....%@@....#+*@@@@=.=*++@@@+@@@@@@@@@@@@@@@@@...........................",
        "..........................@@@@#%%%%%#%%@%%%%%%##%%%#%@%%##%%@@...........@@@@#@=.:+@@@@@=-+=#@@@=%@@@@@@@@@@@@@@@............................",
        "............................@@@@%#%#%@%%#%%##%%%#####%#%%%%%@@@.........@@@@@@==++%@=#@@@-==+@@@=+@@@@@@@%@@@@@..............................",
        "..............................@@@@%@%%%%%%%%%%%%%%%%%%%%%%%##@@#.......#@@@@@*@#::-@@:=#@@:==@@@+-@%@@@@@@@@%................................",
        "................................@@@@@%%%#%%##%#%@@#%%%%%%#%##%@@-.....=@@#@@*.:%-*+@@==+=@#==@@@+.@@@@@@@@...................................",
        "...................................@@@@@%%%%#%%%%%%%%%#%%#%%%%@@@-....@@@-#@...#+#=#@@-=#*+++#@@+-@@@@@@.....................................",
        "......................................@@@@@%%%#%%%%%%%%%%@%%%#%%@@@..@@....@.-=-=--:*@%--#*##=@@@@@@@........................................",
        ".........................................@@@@@@@#%%%%##%%%%%%%@#%@@@@@.....@%:%.=@+=%@@@=-++@@@@@=...........................................",
        ".............................................@@@@@@@@@@%%@%%#%%#%@@+.......@@:..%+.-*@@@@@@@@#...............................................",
        ".................................................:@@@@@@@@@@%#%###@@#=.....=@@:@%@@@@@@@@....................................................",
        "........................................................:@@@@@@@@@@@@@@%=-:+@@@%%-...........................................................",
        ".............................................................................................................................................",
        "............................................................................................................................................."
    };
    
    size_t num_lines = sizeof(art) / sizeof(char*);
    const int delay_us = 100; // 100 microseconds per character

    for (size_t i = 0; i < num_lines; i++) {
        const char *line = art[i];
        for (size_t j = 0; line[j] != '\0'; j++) {
            putchar(line[j]);
            fflush(stdout);
            usleep(delay_us);
        }
        putchar('\n');
    }

    return 1;
}


int shell_next(char **args) {
    const char *last = get_last_real_command();

    if (strlen(last) == 0) {
        printf("No previous command found. Try running a command first.\n");
        return 1;
    }

    printf("\nSuggestions after '%s':\n", last);

    if (strcmp(last, "ls") == 0) {
        printf("  * pwd     : show your current directory\n");
        printf("  * cd      : move to another directory\n");
        printf("  * cat     : read files in the directory\n");
    } 
    else if (strcmp(last, "pwd") == 0) {
        printf("  * ls      : list files in this directory\n");
        printf("  * cd      : change directories\n");
    }
    else if (strcmp(last, "cd") == 0) {
        printf("  * ls      : view the contents of the new directory\n");
        printf("  * pwd     : verify your new working directory\n");
    }
    else if (strcmp(last, "cat") == 0) {
        printf("  * grep    : search inside the file you viewed\n");
        printf("  * ls      : list related files in the directory\n");
    }
    else if (strcmp(last, "grep") == 0) {
        printf("  * cat     : read the file you searched\n");
        printf("  * ls      : inspect additional files\n");
    }
    else if (strcmp(last, "mkdir") == 0) {
        printf("  * ls      : check that the new directory was created\n");
        printf("  * cd      : move into the directory\n");
        printf("  * chmod   : adjust permissions for the new directory\n");
        printf("  * chown   : change ownership of the new directory\n");
    }
    else if (strcmp(last, "touch") == 0) {
        printf("  * ls      : check that the file was created\n");
        printf("  * chmod   : set permissions for the new file\n");
        printf("  * chown   : change ownership of the new file\n");
    }
    else if (strcmp(last, "rm") == 0) {
        printf("  * ls      : verify that the file is gone\n");
        printf("  * mkdir   : create new directories if needed\n");
    }
    else if (strcmp(last, "mv") == 0 || strcmp(last, "cp") == 0) {
        printf("  * ls      : verify the move/copy\n");
        printf("  * chmod   : adjust permissions if needed\n");
        printf("  * chown   : adjust ownership if needed\n");
    }
    else if (strcmp(last, "chmod") == 0) {
        printf("  * ls      : check updated permissions\n");
        printf("  * chown   : adjust ownership if necessary\n");
    }
    else if (strcmp(last, "chown") == 0) {
        printf("  * ls      : verify ownership changes\n");
        printf("  * chmod   : adjust permissions if necessary\n");
    }
    else if (strcmp(last, "ps") == 0 || strcmp(last, "top") == 0) {
        printf("  * kill    : terminate a process\n");
        printf("  * nice    : change process priority\n");
    }
    else {
        // Generic fallback suggestions
        printf("  * ls      : list files\n");
        printf("  * pwd     : show your current directory\n");
        printf("  * cd      : navigate the filesystem\n");
    }

    printf("\n");
    return 1;
}


// ------------------------------------
// Built-in command lookup table
// ------------------------------------

char *builtin_str[] = { "cd", "exit", "help", "next", "wlfc", "history"};

int (*builtin_func[])(char **) = {
    shell_cd,
    shell_exit,
    shell_help,
    shell_next,
    shell_wlfc,
    shell_history
};

int num_builtins() {
    return sizeof(builtin_str) / sizeof(char *);
}